<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Tienda Gamer API</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    body { background-color: #f0f2f5; }
    .card img { height: 220px; object-fit: cover; }
    .admin-panel { display: none; }
    .super-panel { display: none; }
    .card-title { font-weight: 600; }
    .card-text { font-size: 0.9rem; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#"><i class="bi bi-joystick"></i> TIENDAMANIA GAMER</a>
    <div>
      <button id="btnLogin" class="btn btn-outline-light me-2">Iniciar sesión</button>
      <button id="btnLogout" class="btn btn-light d-none">Cerrar sesión <i class="bi bi-box-arrow-right"></i></button>
    </div>
  </div>
</nav>

<div class="container my-4">
  <div class="row">
    <aside class="col-12 col-md-3">
      <div class="card">
        <div class="card-header fw-bold">Categorías</div>
        <div id="categoriesNav" class="list-group list-group-flush">
             <div class="p-3 text-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Cargando...</span></div></div>
        </div>
      </div>
    </aside>

    <main class="col-12 col-md-9">
      <h4 id="productsTitle">Todos los productos</h4>
      <div class="row g-4" id="productsGrid">
        <div class="d-flex justify-content-center mt-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="admin-panel my-5">
    <hr>
    <h2 class="text-center mb-4">Panel de Administración</h2>
    <div class="row g-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header fw-bold"><i class="bi bi-box-seam"></i> Gestión de Productos</div>
                <div class="card-body">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal" onclick="openNewProductModal()">
                        <i class="bi bi-plus-circle"></i> Nuevo Producto
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header fw-bold"><i class="bi bi-tags"></i> Gestión de Categorías</div>
                <div class="card-body">
                    <form id="formCategoria">
                        <div class="input-group">
                            <input id="catNombre" class="form-control" placeholder="Nueva categoría" required>
                            <button class="btn btn-success" type="submit">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div class="super-panel my-5">
      <hr>
      <h2 class="text-center mb-4">Panel de Superusuario</h2>
      <div class="card">
          <div class="card-header fw-bold"><i class="bi bi-people"></i> Gestión de Usuarios</div>
          <div class="card-body">
              <form id="formUsuario" class="row g-3 align-items-end">
                  <div class="col-md-4">
                      <label for="userUsername" class="form-label">Username</label>
                      <input id="userUsername" class="form-control" required>
                  </div>
                  <div class="col-md-4">
                      <label for="userPassword" class="form-label">Password</label>
                      <input id="userPassword" type="password" class="form-control" required>
                  </div>
                  <div class="col-md-2">
                      <label for="userRole" class="form-label">Rol</label>
                      <select id="userRole" class="form-select">
                          <option value="user">Usuario</option>
                          <option value="admin">Admin</option>
                          <option value="super">Super</option>
                      </select>
                  </div>
                  <div class="col-md-2">
                      <button class="btn btn-info w-100" type="submit">Crear Usuario</button>
                  </div>
              </form>
          </div>
          <ul id="userList" class="list-group list-group-flush"></ul>
      </div>
  </div>

</div> <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">Iniciar Sesión</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formLogin">
          <label for="loginUser" class="form-label visually-hidden">Usuario</label>
          <input id="loginUser" class="form-control mb-2" placeholder="Usuario (ej: admin)" required>
          <label for="loginPass" class="form-label visually-hidden">Contraseña</label>
          <input id="loginPass" type="password" class="form-control mb-2" placeholder="Contraseña" required>
          <button class="btn btn-primary w-100">Ingresar</button>
        </form>
        <p id="loginMsg" class="text-danger mt-2 text-center"></p>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="formProducto">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Nuevo Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="prodId">
                    <div class="mb-3">
                        <label for="prodNombre" class="form-label">Nombre</label>
                        <input id="prodNombre" class="form-control" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="prodPrecio" class="form-label">Precio (S/)</label>
                            <input id="prodPrecio" type="number" step="0.01" min="0" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="prodStock" class="form-label">Stock</label>
                            <input id="prodStock" type="number" min="0" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="prodCategoria" class="form-label">Categoría</label>
                        <select id="prodCategoria" class="form-select" required>
                             <option value="" disabled selected>Cargando categorías...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="prodDescripcion" class="form-label">Descripción</label>
                        <textarea id="prodDescripcion" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="prodImagenUrl" class="form-label">URL Imagen Principal (Opcional)</label>
                        <input id="prodImagenUrl" type="url" class="form-control" placeholder="https://ejemplo.com/imagen.jpg">
                        <div class="form-text">Si creas sin imagen, añádela después desde "Ver detalle". Al editar, esto añadirá una imagen *adicional*.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="detalleModal" tabindex="-1" aria-labelledby="detalleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detalleTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-7">
                        <h6>Imágenes</h6>
                        <div id="detalleImagenes" class="row g-2">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Cargando...</span></div>
                            </div>
                        </div>
                        <form id="formImagen" class="input-group mt-3 admin-panel">
                            <input type="hidden" id="imgProductoId">
                            <label for="imgUrl" class="visually-hidden">URL de nueva imagen</label>
                            <input id="imgUrl" type="url" class="form-control" placeholder="URL de nueva imagen" required>
                            <button class="btn btn-success" type="submit">Añadir</button>
                        </form>
                    </div>
                    <div class="col-md-5">
                        <h6>Detalles</h6>
                        <ul id="detalleInfo" class="list-group">
                             </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// --- CONFIG ---
const API_BASE = "https://tienda-gamer-api-v2.onrender.com";
let allCategories = [];
let allProducts = [];
let loginModal, productModal, detalleModal;

// --- API HELPER ---
async function apiFetch(path, options = {}) {
    const token = localStorage.getItem("token");
    if (token) options.headers = { ...options.headers, "Authorization": `Bearer ${token}` };
    const method = options.method || 'GET';
    console.log(`API Call: ${method} ${API_BASE}${path}`);
    try {
        const res = await fetch(API_BASE + path, options);
        const contentType = res.headers.get("content-type");
        let data;
        if (res.status === 204) data = { ok: true, status: 204 };
        else if (contentType?.includes("application/json")) data = await res.json();
        else { const text = await res.text(); data = { ok: res.ok, status: res.status, statusText: res.statusText, text }; }
        if (!res.ok) { console.error(`API Error (${method} ${path}, Status: ${res.status}):`, data); throw data; }
        return data;
    } catch (err) {
        console.error(`API Fetch Exception (${method} ${path}):`, err);
        const errorMsg = err.error || err.message || `Error ${err.status || 'desconocido'}`;
        if (errorMsg.includes("IP no autorizada")) alert(`ERROR: IP no permitida.`);
        else if (err.status === 403) alert(`ERROR: Acceso prohibido (403). Revisa CORS/IP. URL: ${API_BASE}${path}`);
        else if (err instanceof TypeError && err.message === 'Failed to fetch') alert(`Error red/CORS con ${API_BASE}${path}. Revisa consola (F12) y API.`);
        else console.error("Error API:", errorMsg); // No alertar errores genéricos de API aquí
        throw err; // Re-lanzar para detener flujo
    }
}

// --- INITIALIZATION ---
document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM Cargado. Inicializando...");
    const loginModalEl = document.getElementById('loginModal');
    if (loginModalEl) loginModal = new bootstrap.Modal(loginModalEl); else console.error("FATAL: #loginModal");
    const productModalEl = document.getElementById('productModal');
    if (productModalEl) productModal = new bootstrap.Modal(productModalEl); else console.error("FATAL: #productModal");
    const detalleModalEl = document.getElementById('detalleModal');
    if (detalleModalEl) detalleModal = new bootstrap.Modal(detalleModalEl); else console.error("FATAL: #detalleModal");

    if (loginModal && productModal && detalleModal) {
         console.log("Modales inicializados.");
         setupEventListeners();
         checkLoginStatus();
         loadInitialData();
    } else { alert("Error crítico inicializando modales. Revisa consola (F12)."); }
});

// --- EVENT LISTENERS ---
function setupEventListeners() {
    document.getElementById('btnLogin')?.addEventListener('click', () => loginModal?.show());
    document.getElementById('btnLogout')?.addEventListener('click', logout);
    document.getElementById('formLogin')?.addEventListener('submit', handleLogin);
    document.getElementById('formCategoria')?.addEventListener('submit', handleCreateCategory);
    document.getElementById('formProducto')?.addEventListener('submit', handleCreateOrUpdateProduct);
    document.getElementById('formImagen')?.addEventListener('submit', handleCreateImage);
    document.getElementById('formUsuario')?.addEventListener('submit', handleCreateUser);
    console.log("Listeners configurados.");
}

// --- DATA LOADING ---
async function loadInitialData() {
    console.log("Cargando datos iniciales...");
    const grid = document.getElementById('productsGrid');
    if(grid) grid.innerHTML = "<div class='d-flex justify-content-center mt-5'><div class='spinner-border text-primary' role='status'><span class='visually-hidden'>Cargando...</span></div></div>";
    try {
        await loadCategories(); // Esperar a que las categorías carguen primero
        await loadProducts();   // Cargar productos después
        console.log("Datos iniciales cargados OK.");
    } catch (error) {
        console.error("Error cargando datos iniciales:", error);
        if(grid) grid.innerHTML = "<p class='text-danger text-center'>Error al cargar datos iniciales. Revisa la consola (F12) y la conexión con la API.</p>";
    }
}

// --- AUTH LOGIC ---
async function handleLogin(e) {
    e.preventDefault();
    const loginUserEl = document.getElementById('loginUser');
    const loginPassEl = document.getElementById('loginPass');
    const loginMsgEl = document.getElementById('loginMsg');
    if (!loginUserEl || !loginPassEl || !loginMsgEl) return;
    loginMsgEl.textContent = "Ingresando...";
    try {
        const res = await apiFetch("/login", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: loginUserEl.value, password: loginPassEl.value })
        });
        localStorage.setItem("token", res.token); localStorage.setItem("role", res.role);
        loginMsgEl.textContent = ""; loginModal?.hide(); checkLoginStatus(); loadProducts();
        console.log("Login OK!");
    } catch (err) {
        loginMsgEl.textContent = "❌ " + (err.error || "Credenciales incorrectas.");
        console.error("Fallo login:", err);
    }
}
function logout() {
    localStorage.removeItem("token"); localStorage.removeItem("role");
    checkLoginStatus(); loadProducts(); console.log("Logout OK.");
}
function checkLoginStatus() {
    const token = localStorage.getItem("token"); const role = localStorage.getItem("role");
    const isAdmin = role === 'admin' || role === 'super'; const isSuper = role === 'super';
    document.querySelectorAll('.admin-panel').forEach(el => el.style.display = isAdmin ? 'block' : 'none');
    document.querySelectorAll('.super-panel').forEach(el => el.style.display = isSuper ? 'block' : 'none');
    document.getElementById('btnLogout')?.classList.toggle("d-none", !token);
    document.getElementById('btnLogin')?.classList.toggle("d-none", !!token);
    if (isSuper) loadUsers(); else { const ul = document.getElementById('userList'); if(ul) ul.innerHTML = ''; }
    console.log("Login check. Rol:", role || "Ninguno");
}

// --- CATEGORIES LOGIC ---
async function loadCategories() {
    console.log("Cargando categorías...");
    const nav = document.getElementById("categoriesNav");
    if(nav) nav.innerHTML = "<div class='p-3 text-center'><div class='spinner-border spinner-border-sm'></div></div>";
    try {
        allCategories = await apiFetch("/categorias");
        if (!Array.isArray(allCategories)) throw new Error("Respuesta no es array.");
        renderCategories(allCategories);
        updateCategorySelect(allCategories); // Poblar el select AHORA
        console.log("Categorías OK:", allCategories.length);
    } catch (err) {
        console.error("Error cargando categorías:", err);
        if (nav) nav.innerHTML = "<p class='text-danger p-2'>Error al cargar.</p>";
        throw err; // Lanzar error para detener loadInitialData
    }
}
function renderCategories(categories) {
    const nav = document.getElementById("categoriesNav"); if (!nav) return;
    nav.innerHTML = '<a href="#" class="list-group-item list-group-item-action active" data-id="all">Todos</a>';
    categories.forEach(c => nav.innerHTML += `<a href="#" class="list-group-item list-group-item-action" data-id="${c.id}">${c.nombre || 'Sin nombre'}</a>`);
    nav.querySelectorAll('a').forEach(a => {
        a.onclick = (e) => {
            e.preventDefault();
            nav.querySelector('.active')?.classList.remove('active'); a.classList.add('active');
            const catId = a.getAttribute('data-id'); const title = document.getElementById('productsTitle');
            if(title) title.textContent = (catId === 'all') ? 'Todos los productos' : `Productos en ${a.textContent}`;
            renderProducts((catId === 'all') ? allProducts : allProducts.filter(p => p.categoria_id == catId));
            console.log("Filtro categoría:", catId);
        };
    });
}
async function handleCreateCategory(e) {
    e.preventDefault();
    const input = document.getElementById('catNombre'); const nombre = input ? input.value.trim() : ''; if (!nombre) return;
    console.log("Creando categoría:", nombre);
    try {
        const newCat = await apiFetch("/categorias", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ nombre }) });
        console.log("Categoría creada:", newCat); if (input) input.value = ""; loadCategories();
    } catch (err) { alert("Error creando categoría: " + (err.error || '¿Ya existe?')); console.error("Fallo crear cat:", err); }
}

// --- PRODUCTS LOGIC ---
async function loadProducts() {
    console.log("Cargando productos...");
    const grid = document.getElementById("productsGrid"); if (!grid) return;
    grid.innerHTML = "<div class='d-flex justify-content-center mt-5'><div class='spinner-border text-primary'></div></div>";
    try {
        const prods = await apiFetch("/productos");
        if (!Array.isArray(prods)) throw new Error("Respuesta no es array.");
        allProducts = prods.map(p => ({ ...p, firstImageUrl: p.firstimageurl || 'https://via.placeholder.com/300/CCCCCC/FFFFFF?text=Sin+Imagen' }));
        renderProducts(allProducts);
        const catNav = document.getElementById('categoriesNav');
        catNav?.querySelector('.active')?.classList.remove('active'); catNav?.querySelector('[data-id="all"]')?.classList.add('active');
        const title = document.getElementById('productsTitle'); if(title) title.textContent = 'Todos los productos';
        console.log("Productos OK:", allProducts.length);
    } catch (err) {
        console.error("Error cargando productos:", err);
        grid.innerHTML = "<p class='text-danger text-center'>Error al cargar productos. Revisa consola (F12).</p>";
        throw err; // Lanzar error
    }
}
function renderProducts(products) {
    const grid = document.getElementById("productsGrid"); if (!grid) return;
    grid.innerHTML = ""; if (products.length === 0) { grid.innerHTML = "<p class='text-center'>No hay productos que mostrar.</p>"; return; }
    const role = localStorage.getItem("role"); const isAdmin = role === 'admin' || role === 'super';
    products.forEach(p => {
        const adminBtns = isAdmin ? `<button class="btn btn-sm btn-outline-secondary me-2" onclick="openEditProductModal(${p.id})"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${p.id})"><i class="bi bi-trash"></i></button>` : '';
        grid.innerHTML += `
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card h-100 shadow-sm">
            <img src="${p.firstImageUrl}" class="card-img-top" alt="${p.nombre || 'Producto'}">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">${p.nombre || 'Sin nombre'}</h5>
              <p class="card-text text-muted">${p.categoria || "Sin categoría"}</p>
              <h4 class="mt-auto">S/ ${Number(p.precio || 0).toFixed(2)}</h4>
            </div>
            <div class="card-footer bg-white border-top-0 pb-3 d-flex justify-content-between align-items-center">
              <button class="btn btn-sm btn-primary" onclick="openDetalleModal(${p.id})">Ver detalle</button>
              <div>${adminBtns}</div>
            </div>
          </div>
        </div>`;
    });
}
function openNewProductModal() {
    const title = document.getElementById('productModalTitle'); const form = document.getElementById('formProducto');
    const idInput = document.getElementById('prodId'); const imgInput = document.getElementById('prodImagenUrl');
    if (title) title.textContent = 'Nuevo Producto'; if (form) form.reset(); if (idInput) idInput.value = ''; if (imgInput) imgInput.value = '';
    console.log("Modal listo para nuevo producto.");
    // Asegurar que el select de categoría esté poblado
    if(document.getElementById('prodCategoria').options.length <= 1 && allCategories.length > 0) {
        updateCategorySelect(allCategories);
    }
}
function openEditProductModal(id) {
    const product = allProducts.find(p => p.id === id); if (!product) { console.error("Producto no encontrado:", id); return; }
    console.log("Abriendo modal para editar:", product);
    const title = document.getElementById('productModalTitle'); const idInput = document.getElementById('prodId');
    const nameInput = document.getElementById('prodNombre'); const priceInput = document.getElementById('prodPrecio');
    const stockInput = document.getElementById('prodStock'); const catSelect = document.getElementById('prodCategoria');
    const descArea = document.getElementById('prodDescripcion'); const imgInput = document.getElementById('prodImagenUrl');

    if (title) title.textContent = 'Editar Producto'; if (idInput) idInput.value = product.id;
    if (nameInput) nameInput.value = product.nombre || ''; if (priceInput) priceInput.value = product.precio || '';
    if (stockInput) stockInput.value = product.stock || ''; if (descArea) descArea.value = product.descripcion || '';
    if (imgInput) imgInput.value = ''; // Limpiar campo imagen al editar

    // Seleccionar categoría con seguridad
    if (catSelect && catSelect.options.length > 0) {
        if ([...catSelect.options].some(opt => opt.value == product.categoria_id)) {
             catSelect.value = product.categoria_id; console.log("Cat seleccionada:", product.categoria_id);
        } else { console.warn(`Cat ID ${product.categoria_id} no encontrada.`); }
    } else if (catSelect) { console.error("Select categorías vacío al editar."); }

    productModal?.show();
}

async function handleCreateOrUpdateProduct(e) {
    e.preventDefault();
    const idInput = document.getElementById('prodId'); const productId = idInput ? idInput.value : ''; const isEditing = !!productId;
    const nombre = document.getElementById('prodNombre')?.value.trim() || '';
    const precio = parseFloat(document.getElementById('prodPrecio')?.value || '0');
    const stock = parseInt(document.getElementById('prodStock')?.value || '0', 10);
    const categoria_id = parseInt(document.getElementById('prodCategoria')?.value || '0', 10);
    const descripcion = document.getElementById('prodDescripcion')?.value.trim() || '';
    const imagenUrl = document.getElementById('prodImagenUrl')?.value.trim() || '';

    const productData = { nombre, precio, stock, categoria_id, descripcion };

    if (!nombre || isNaN(precio) || precio <= 0 || isNaN(stock) || stock < 0 || isNaN(categoria_id) || categoria_id <= 0) {
        alert("Completa campos requeridos (Nombre, Precio > 0, Stock >= 0, Categoría)."); return;
    }
    if (imagenUrl && (!imagenUrl.startsWith('http://') && !imagenUrl.startsWith('https://'))) {
         alert("URL de imagen inválida (http:// o https://)."); return;
    }

    console.log(isEditing ? "Actualizando:" : "Creando:", productData, "Img:", imagenUrl || "No");
    try {
        const savedProduct = await apiFetch(isEditing ? `/productos/${productId}` : '/productos', {
            method: isEditing ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(productData)
        });
        console.log("Producto guardado:", savedProduct);
        const productIdToUse = savedProduct?.id || (isEditing ? parseInt(productId, 10) : null);

        if (imagenUrl && productIdToUse) {
            console.log(`Añadiendo img ${imagenUrl} a prod ${productIdToUse}`);
            try {
                await apiFetch('/imagenes', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: imagenUrl, producto_id: productIdToUse }) });
                console.log("Imagen añadida (o intentada).");
            } catch (imgErr) { console.error("Error añadiendo imagen:", imgErr); alert("Prod guardado, pero error al añadir imagen: " + (imgErr.error || 'Desconocido')); }
        }
        productModal?.hide(); loadProducts();
    } catch (err) { alert('Error guardando producto: ' + (err.error || 'Revisa consola.')); console.error("Fallo guardar prod:", err); }
}

async function deleteProduct(id) {
    if (!confirm(`¿Eliminar producto ID ${id}?`)) return; console.log("Eliminando:", id);
    try { await apiFetch(`/productos/${id}`, { method: 'DELETE' }); console.log("Eliminado OK:", id); loadProducts(); }
    catch (err) { alert("Error eliminando: " + (err.error || 'Revisa consola')); }
}

// --- DETAILS & IMAGES LOGIC ---
async function openDetalleModal(id) {
    const p = allProducts.find(x => x.id === id); if (!p) { console.error("Prod no encontrado:", id); return; } console.log("Abriendo detalle:", p);
    const title = document.getElementById('detalleTitle'); const imgIdInput = document.getElementById('imgProductoId'); const infoUl = document.getElementById('detalleInfo');
    if (title) title.textContent = p.nombre || 'Detalle'; if (imgIdInput) imgIdInput.value = id;
    if (infoUl) infoUl.innerHTML = `<li class="list-group-item"><b>Precio:</b> S/ ${Number(p.precio||0).toFixed(2)}</li><li class="list-group-item"><b>Stock:</b> ${p.stock ?? 'N/A'} u.</li><li class="list-group-item"><b>Categoría:</b> ${p.categoria || "N/A"}</li><li class="list-group-item"><b>Descripción:</b> ${p.descripcion || "N/A"}</li>`;
    detalleModal?.show(); loadProductImages(id);
}
async function loadProductImages(productId) {
    const gal = document.getElementById("detalleImagenes"); if (!gal) return;
    gal.innerHTML = "<div class='spinner-border spinner-border-sm'><span class='visually-hidden'>Cargando...</span></div>"; console.log("Cargando imgs:", productId);
    try {
        const images = await apiFetch(`/imagenes/${productId}`); gal.innerHTML = "";
        if (!images || !Array.isArray(images) || images.length === 0) { gal.innerHTML = "<p>Sin imágenes.</p>"; }
        else { images.forEach(i => { const url = i.url || 'https://via.placeholder.com/150?text=Inválida'; gal.innerHTML += `<div class="col-6 mb-2 position-relative"><img src="${url}" class="img-fluid rounded" alt="Img ${productId}"></div>`; }); }
        console.log("Imgs OK:", images ? images.length : 0);
    } catch (err) { gal.innerHTML = "<p class='text-danger'>Error cargando imgs.</p>"; console.error("Fallo cargar imgs:", err); }
}
async function handleCreateImage(e) {
    e.preventDefault();
    const idInput = document.getElementById('imgProductoId'); const urlInput = document.getElementById('imgUrl');
    const prodId = idInput ? idInput.value : ''; const url = urlInput ? urlInput.value.trim() : '';
    if (!url || !prodId) { alert("URL requerida."); return; } if (!url.startsWith('http://') && !url.startsWith('https://')) { alert("URL inválida."); return; }
    console.log("Añadiendo img:", url, "a prod:", prodId);
    try {
        const newImg = await apiFetch('/imagenes', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url, producto_id: parseInt(prodId, 10) }) });
        console.log("Img añadida:", newImg); if (urlInput) urlInput.value = ''; loadProductImages(prodId);
        // loadProducts(); // Opcional
    } catch (err) { alert('Error añadiendo img: ' + (err.error || '¿URL válida?')); console.error("Fallo añadir img:", err); }
}

// --- USERS LOGIC ---
async function loadUsers() {
    const panel = document.querySelector('.super-panel'); const list = document.getElementById("userList");
    if (!panel || panel.style.display !== 'block' || !list) return;
    console.log("Cargando usuarios..."); list.innerHTML = "<li class='list-group-item'><div class='spinner-border spinner-border-sm'></div></li>";
    try { const users = await apiFetch("/usuarios"); if (!Array.isArray(users)) throw new Error("No es array."); renderUsers(users); console.log("Usuarios OK:", users.length); }
    catch(err) { console.error("Error cargando usuarios:", err); list.innerHTML = "<li class='list-group-item text-danger'>Error.</li>"; }
}
function renderUsers(users) {
    const list = document.getElementById("userList"); if (!list) return; list.innerHTML = "";
    if (users.length === 0) { list.innerHTML = "<li class='list-group-item'>Sin usuarios.</li>"; return; }
    users.forEach(u => list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><div> <i class="bi bi-person-circle me-2"></i> <strong>${u.username||'N/A'}</strong> </div><span class="badge bg-secondary rounded-pill">${u.role||'N/A'}</span></li>`);
}
async function handleCreateUser(e) {
    e.preventDefault();
    const userInput = document.getElementById('userUsername'); const passInput = document.getElementById('userPassword'); const roleSelect = document.getElementById('userRole');
    const data = { username: userInput?.value.trim() || '', password: passInput?.value || '', role: roleSelect?.value || 'user' };
    if (!data.username || !data.password) { alert("Username y Password requeridos."); return; }
    console.log("Creando usuario:", data.username, "Rol:", data.role);
    try { const newUser = await apiFetch('/usuarios', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); console.log("Usuario creado:", newUser); document.getElementById('formUsuario')?.reset(); loadUsers(); }
    catch (err) { alert("Error creando usuario: " + (err.error || "¿Username ya existe?")); console.error("Fallo crear usuario:", err); }
}

// --- HELPERS ---
function updateCategorySelect(categories) {
    const select = document.getElementById("prodCategoria"); if (!select) return;
    const selectedValue = select.value; // Guardar valor actual si existe
    // Asegurar que categories sea un array y poblar
    select.innerHTML = Array.isArray(categories) ? categories.map(c => `<option value="${c.id}">${c.nombre || 'Sin nombre'}</option>`).join("") : '<option value="" disabled>Error al cargar</option>';
    // Añadir opción por defecto si estaba vacío
    if (!select.querySelector('option[selected]')) {
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = "-- Selecciona Categoría --";
        defaultOption.disabled = true;
        defaultOption.selected = true; // Seleccionar por defecto
        select.prepend(defaultOption);
    }
    // Restaurar valor si aún existe, si no, dejar la opción por defecto
    if ([...select.options].some(opt => opt.value == selectedValue)) { select.value = selectedValue; }
    else { select.value = ""; } // Forzar selección por defecto si el valor anterior ya no es válido
    console.log("Select categorías actualizado.");
}

</script>
</body>
</html>